from flask import Blueprint, render_template, request, redirect, url_for, make_response, flash
from werkzeug.security import generate_password_hash, check_password_hash
from models.makerspace import *
from itsdangerous import URLSafeTimedSerializer, BadSignature, SignatureExpired # password reset token
from . import webapp_main

MUNICIP = ['Acme Township', 'Ada Township', 'Adams Township', 'Adams Township', 'Adams Township', 'Addison Village', 'Addison Township', 'Adrian City', 'Adrian Charter Township', 'Aetna Township', 'Aetna Township', 'Ahmeek Village', 'Akron Village', 'Akron Township', 'Alabaster Township', 'Alaiedon Township', 'Alamo Township', 'Alanson Village', 'Albee Township', 'Albert Township', 'Albion City', 'Albion Township', 'Alcona Township', 'Algansee Township', 'Algoma Township', 'Algonac City', 'Allegan City', 'Allegan Township', 'Allen Village', 'Allen Township', 'Allendale Charter Township', 'Allen Park City', 'Allis Township', 'Allouez Township', 'Alma City', 'Almena Township', 'Almer Charter Township', 'Almira Township', 'Almont Village', 'Almont Township', 'Aloha Township', 'Alpena City', 'Alpena Charter Township', 'Alpha Village', 'Alpine Township', 'Amber Township', 'Amboy Township', 'Ann Arbor City', 'Ann Arbor Charter Township', 'Antioch Township', 'Antrim Township', 'Antwerp Township', 'Applegate Village', 'Arbela Township', 'Arcada Township', 'Arcadia Township', 'Arcadia Township', 'Arenac Township', 'Argentine Township', 'Argyle Township', 'Arlington Township', 'Armada Village', 'Armada Township', 'Arthur Township', 'Arvon Township', 'Ash Township', 'Ashland Township', 'Ashley Village', 'Assyria Township', 'Athens Village', 'Athens Township', 'Atlas Township', 'Attica Township', 'Auburn City', 'Auburn Hills City', 'Au Gres City', 'Au Gres Township', 'Augusta Village', 'Augusta Charter Township', 'Aurelius Township', 'Au Sable Charter Township', 'Au Sable Township', 'Austin Township', 'Austin Township', 'Au Train Township', 'Avery Township', 'Backus Township', 'Bad Axe City', 'Bagley Township', 'Bainbridge Township', 'Baldwin Township', 'Baldwin Township', 'Baldwin Village', 'Baltimore Township', 'Bancroft Village', 'Bangor Charter Township', 'Bangor City', 'Bangor Township', 'Banks Township', 'Baraga Village', 'Baraga Township', 'Bark River Township', 'Baroda Village', 'Baroda Township', 'Barry Township', 'Barryton Village', 'Barton Township', 'Barton Hills Village', 'Batavia Township', 'Bates Township', 'Bath Charter Township', 'Battle Creek City', 'Bay Township', 'Bay City City', 'Bay de Noc Township', 'Bay Mills Township', 'Bear Creek Township', 'Bearinger Township', 'Bear Lake Township', 'Bear Lake Village', 'Bear Lake Township', 'Beaugrand Township', 'Beaver Township', 'Beaver Township', 'Beaver Creek Township', 'Beaverton City', 'Beaverton Township', 'Bedford Charter Township', 'Bedford Township', 'Belding City', 'Belknap Township', 'Bellaire Village', 'Belleville City', 'Bellevue Village', 'Bellevue Township', 'Belvidere Township', 'Bengal Township', 'Bennington Township', 'Benona Township', 'Bentley Township', 'Benton Charter Township', 'Benton Township', 'Benton Township', 'Benton Harbor City', 'Benzonia Village', 'Benzonia Township', 'Bergland Township', 'Berkley City', 'Berlin Township', 'Berlin Charter Township', 'Berlin Township', 'Berrien Township', 'Berrien Springs Village', 'Bertrand Township', 'Bessemer City', 'Bessemer Township', 'Bethany Township', 'Bethel Township', 'Beulah Village', 'Beverly Hills Village', 'Big Creek Township', 'Big Prairie Township', 'Big Rapids City', 'Big Rapids Charter Township', 'Billings Township', 'Bingham Township', 'Bingham Township', 'Bingham Township', 'Bingham Farms Village', 'Birch Run Village', 'Birch Run Township', 'Birmingham City', 'Bismarck Township', 'Blackman Charter Township', 'Blaine Township', 'Blair Township', 'Blendon Township', 'Bliss Township', 'Blissfield Village', 'Blissfield Township', 'Bloomer Township', 'Bloomfield Township', 'Bloomfield Township', 'Bloomfield Charter Township', 'Bloomfield Hills City', 'Bloomingdale Village', 'Bloomingdale Township', 'Blue Lake Township', 'Blue Lake Township', 'Blumfield Township', 'Boardman Township', 'Bohemia Township', 'Bois Blanc Township', 'Boon Township', 'Boston Township', 'Bourret Township', 'Bowne Township', 'Boyne City City', 'Boyne Falls Village', 'Boyne Valley Township', 'Brady Township', 'Brady Township', 'Brampton Township', 'Branch Township', 'Brandon Charter Township', 'Brant Township', 'Breckenridge Village', 'Breedsville Village', 'Breen Township', 'Breitung Charter Township', 'Brevort Township', 'Bridgehampton Township', 'Bridgeport Charter Township', 'Bridgeton Township', 'Bridgewater Township', 'Bridgman City', 'Brighton City', 'Brighton Charter Township', 'Briley Township', 'Britton Village', 'Brockway Township', 'Bronson City', 'Bronson Township', 'Brookfield Township', 'Brookfield Township', 'Brooklyn Village', 'Brooks Township', 'Broomfield Township', 'Brown Township', 'Brown City City', 'Brownstown Charter Township', 'Bruce Township', 'Bruce Township', 'Buchanan City', 'Buchanan Township', 'Buckeye Township', 'Buckley Village', 'Buel Township', 'Buena Vista Charter Township', 'Bunker Hill Township', 'Burdell Township', 'Burleigh Township', 'Burlington Village', 'Burlington Township', 'Burlington Township', 'Burns Township', 'Burnside Township', 'Burr Oak Village', 'Burr Oak Township', 'Burt Township', 'Burt Township', 'Burtchville Township', 'Burton City', 'Bushnell Township', 'Butler Township', 'Butman Township', 'Butterfield Township', 'Byron Township', 'Byron Village', 'Cadillac City', 'Caldwell Township', 'Caledonia Township', 'Caledonia Village', 'Caledonia Charter Township', 'Caledonia Charter Township', 'California Township', 'Calumet Village', 'Calumet Charter Township', 'Calvin Township', 'Cambria Township', 'Cambridge Township', 'Camden Village', 'Camden Township', 'Campbell Township', 'Cannon Township', 'Canton Charter Township', 'Capac Village', 'Carleton Village', 'Carlton Township', 'Carmel Township', 'Carney Village', 'Caro City', 'Carp Lake Township', 'Carp Lake Township', 'Carrollton Township', 'Carson City City', 'Carsonville Village', 'Cascade Charter Township', 'Casco Township', 'Casco Township', 'Case Township', 'Caseville City', 'Caseville Township', 'Casnovia Village', 'Casnovia Township', 'Caspian City', 'Cass City Village', 'Cassopolis Village', 'Castleton Township', 'Cato Township', 'Cedar Township', 'Cedar Creek Township', 'Cedar Creek Township', 'Cedar Springs City', 'Cedarville Township', 'Cement City Village', 'Center Township', 'Center Line City', 'Centerville Township', 'Central Lake Village', 'Central Lake Township', 'Centreville Village', 'Champion Township', 'Chandler Township', 'Chandler Township', 'Chapin Township', 'Charleston Township', 'Charlevoix City', 'Charlevoix Township', 'Charlotte City', 'Charlton Township', 'Chase Township', 'Chassell Township', 'Chatham Village', 'Cheboygan City', 'Chelsea City', 'Cherry Grove Township', 'Cherry Valley Township', 'Chesaning Village', 'Chesaning Township', 'Cheshire Township', 'Chester Township', 'Chester Township', 'Chester Township', 'Chesterfield Charter Township', 'Chestonia Township', 'Chikaming Township', 'China Charter Township', 'Chippewa Township', 'Chippewa Township', 'Chippewa Township', 'Chocolay Charter Township', 'Churchill Township', 'Clam Lake Township', 'Clam Union Township', 'Clare City', 'Clarence Township', 'Clarendon Township', 'Clark Township', 'Clarksville Village', 'Clawson City', 'Clay Township', 'Claybanks Township', 'Clayton Township', 'Clayton Charter Township', 'Clayton Village', 'Clearwater Township', 'Clement Township', 'Cleon Township', 'Cleveland Township', 'Clifford Village', 'Climax Village', 'Climax Township', 'Clinton Village', 'Clinton Township', 'Clinton Charter Township', 'Clinton Township', 'Clio City', 'Clyde Township', 'Clyde Township', 'Coe Township', 'Cohoctah Township', 'Coldsprings Township', 'Coldwater City', 'Coldwater Township', 'Coldwater Township', 'Coleman City', 'Colfax Township', 'Colfax Township', 'Colfax Township', 'Colfax Township', 'Colfax Township', 'Coloma City', 'Coloma Charter Township', 'Colon Village', 'Colon Township', 'Columbia Township', 'Columbia Township', 'Columbia Township', 'Columbiaville Village', 'Columbus Township', 'Columbus Township', 'Comins Township', 'Commerce Charter Township', 'Comstock Charter Township', 'Concord Village', 'Concord Township', 'Constantine Village', 'Constantine Township', 'Convis Township', 'Conway Township', 'Cooper Charter Township', 'Coopersville City', 'Copemish Village', 'Copper City Village', 'Cornell Township', 'Corunna City', 'Corwith Township', 'Cottrellville Township', 'Courtland Township', 'Covert Township', 'Covington Township', 'Crockery Township', 'Cross Village Township', 'Croswell City', 'Croton Township', 'Crystal Township', 'Crystal Township', 'Crystal Falls City', 'Crystal Falls Township', 'Crystal Lake Township', 'Cumming Township', 'Curtis Township', 'Custer Township', 'Custer Village', 'Custer Township', 'Custer Township', 'Dafter Township', 'Daggett Village', 'Daggett Township', 'Dallas Township', 'Dalton Township', 'Danby Township', 'Dansville Village', 'Davison City', 'Davison Township', 'Day Township', 'Dayton Township', 'Dayton Township', 'Dearborn City', 'Dearborn Heights City', 'Decatur Village', 'Decatur Township', 'Deckerville Village', 'Deep River Township', 'Deerfield Township', 'Deerfield Township', 'Deerfield Village', 'Deerfield Township', 'Deerfield Township', 'Deerfield Township', 'Delaware Township', 'Delhi Charter Township', 'Delta Charter Township', 'Denmark Township', 'Denton Township', 'Denver Township', 'Denver Township', 'Detour Township', 'DeTour Village Village', 'Detroit City', 'DeWitt City', 'DeWitt Charter Township', 'Dexter City', 'Dexter Township', 'Dickson Township', 'Dimondale Village', 'Dorr Township', 'Douglas City', 'Douglass Township', 'Dover Township', 'Dover Township', 'Dover Township', 'Dowagiac City', 'Doyle Township', 'Drummond Township', 'Dryden Village', 'Dryden Township', 'Duncan Township', 'Dundee Village', 'Dundee Township', 'Duplain Township', 'Durand City', 'Dwight Township', 'Eagle Village', 'Eagle Township', 'Eagle Harbor Township', 'East Bay Charter Township', 'East China Charter Township', 'East Grand Rapids City', 'East Jordan City', 'Eastlake Village', 'East Lansing City', 'Easton Township', 'Eastpointe City', 'East Tawas City', 'Eaton Township', 'Eaton Rapids City', 'Eaton Rapids Township', 'Eau Claire Village', 'Echo Township', 'Eckford Township', 'Ecorse City', 'Eden Township', 'Eden Township', 'Edenville Township', 'Edmore Village', 'Edwards Township', 'Edwardsburg Village', 'Egelston Township', 'Elba Township', 'Elba Township', 'Elberta Village', 'Elbridge Township', 'Elk Township', 'Elk Township', 'Elkland Township', 'Elk Rapids Village', 'Elk Rapids Township', 'Elkton Village', 'Ellington Township', 'Ellis Township', 'Ellsworth Village', 'Ellsworth Township', 'Elmer Township', 'Elmer Township', 'Elmira Township', 'Elm River Township', 'Elmwood Charter Township', 'Elmwood Township', 'Elsie Village', 'Ely Township', 'Emerson Township', 'Emmett Charter Township', 'Emmett Village', 'Emmett Township', 'Empire Village', 'Empire Township', 'Ensign Township', 'Ensley Township', 'Enterprise Township', 'Erie Township', 'Erwin Township', 'Escanaba City', 'Escanaba Township', 'Essex Township', 'Essexville City', 'Estral Beach Village', 'Eureka Charter Township', 'Evangeline Township', 'Evart City', 'Evart Township', 'Eveline Township', 'Everett Township', 'Evergreen Township', 'Evergreen Township', 'Ewing Township', 'Excelsior Township', 'Exeter Township', 'Fabius Township', 'Fairbanks Township', 'Fairfield Township', 'Fairfield Township', 'Fairgrove Village', 'Fairgrove Township', 'Fairhaven Township', 'Fairplain Township', 'Faithorn Township', 'Farmington City', 'Farmington Hills City', 'Farwell Village', 'Fawn River Township', 'Fayette Township', 'Felch Township', 'Fennville City', 'Fenton City', 'Fenton Charter Township', 'Ferndale City', 'Ferris Township', 'Ferry Township', 'Ferrysburg City', 'Fife Lake Village', 'Fife Lake Township', 'Filer Charter Township', 'Fillmore Township', 'Flat Rock City', 'Flint City', 'Flint Charter Township', 'Florence Township', 'Flowerfield Township', 'Flushing City', 'Flushing Charter Township', 'Flynn Township', 'Ford River Township', 'Forest Township', 'Forest Township', 'Forest Township', 'Forester Township', 'Forest Home Township', 'Forestville Village', 'Fork Township', 'Forsyth Township', 'Fort Gratiot Charter Township', 'Foster Township', 'Fountain Village', 'Fowler Village', 'Fowlerville Village', 'Frankenlust Township', 'Frankenmuth City', 'Frankenmuth Township', 'Frankfort City', 'Franklin Township', 'Franklin Township', 'Franklin Township', 'Franklin Village', 'Fraser Township', 'Fraser City', 'Frederic Township', 'Fredonia Township', 'Freedom Township', 'Freeman Township', 'Freeport Village', 'Free Soil Village', 'Free Soil Township', 'Fremont Township', 'Fremont City', 'Fremont Township', 'Fremont Township', 'Fremont Township', 'Frenchtown Charter Township', 'Friendship Township', 'Frost Township', 'Fruitland Township', 'Fruitport Village', 'Fruitport Charter Township', 'Fulton Township', 'Gaastra City', 'Gagetown Village', 'Gaines Village', 'Gaines Township', 'Gaines Charter Township', 'Galesburg City', 'Galien Village', 'Galien Township', 'Ganges Township', 'Garden Village', 'Garden Township', 'Garden City City', 'Garfield Township', 'Garfield Township', 'Garfield Charter Township', 'Garfield Township', 'Garfield Township', 'Garfield Township', 'Gaylord City', 'Genesee Charter Township', 'Geneva Township', 'Geneva Township', 'Genoa Charter Township', 'Georgetown Charter Township', 'Germfask Township', 'Gerrish Township', 'Gibraltar City', 'Gibson Township', 'Gilead Township', 'Gilford Township', 'Gilmore Township', 'Gilmore Township', 'Girard Township', 'Gladstone City', 'Gladwin City', 'Gladwin Township', 'Glen Arbor Township', 'Gobles City', 'Golden Township', 'Goodar Township', 'Goodland Township', 'Goodrich Village', 'Goodwell Township', 'Gore Township', 'Gourley Township', 'Grand Beach Village', 'Grand Blanc City', 'Grand Blanc Charter Township', 'Grand Haven City', 'Grand Haven Charter Township', 'Grand Island Township', 'Grand Ledge City', 'Grand Rapids City', 'Grand Rapids Charter Township', 'Grandville City', 'Grant Township', 'Grant Township', 'Grant Township', 'Grant Township', 'Grant Township', 'Grant Township', 'Grant Township', 'Grant Township', 'Grant City', 'Grant Township', 'Grant Township', 'Grant Township', 'Grass Lake Village', 'Grass Lake Charter Township', 'Grattan Township', 'Grayling City', 'Grayling Charter Township', 'Green Township', 'Green Charter Township', 'Greenbush Township', 'Greenbush Township', 'Greendale Township', 'Green Lake Township', 'Greenland Township', 'Greenleaf Township', 'Green Oak Charter Township', 'Greenville City', 'Greenwood Township', 'Greenwood Township', 'Greenwood Township', 'Greenwood Township', 'Greenwood Township', 'Grim Township', 'Grosse Ile Township', 'Grosse Pointe City', 'Grosse Pointe Farms City', 'Grosse Pointe Park City', 'Grosse Pointe Woods City', 'Grout Township', 'Groveland Township', 'Gun Plain Charter Township', 'Gustin Township', 'Hadley Township', 'Hagar Township', 'Haight Township', 'Hamburg Township', 'Hamilton Township', 'Hamilton Township', 'Hamilton Township', 'Hamlin Township', 'Hamlin Township', 'Hampton Charter Township', 'Hamtramck City', 'Hancock City', 'Hancock Township', 'Handy Township', 'Hanover Village', 'Hanover Township', 'Hanover Township', 'Harbor Beach City', 'Harbor Springs City', 'Haring Charter Township', 'Harper Woods City', 'Harrietta Village', 'Harris Township', 'Harrison City', 'Harrison Charter Township', 'Harrisville City', 'Harrisville Township', 'Hart City', 'Hart Township', 'Hartford City', 'Hartford Township', 'Hartland Township', 'Hartwick Township', 'Hastings City', 'Hastings Charter Township', 'Hatton Township', 'Hawes Township', 'Hay Township', 'Hayes Township', 'Hayes Township', 'Hayes Township', 'Haynes Township', 'Hazel Park City', 'Hazelton Township', 'Heath Township', 'Hebron Township', 'Helena Township', 'Hematite Township', 'Henderson Township', 'Hendricks Township', 'Henrietta Township', 'Hersey Village', 'Hersey Township', 'Hesperia Village', 'Hiawatha Township', 'Higgins Township', 'Highland Charter Township', 'Highland Township', 'Highland Park City', 'Hill Township', 'Hillman Village', 'Hillman Township', 'Hillsdale City', 'Hillsdale Township', 'Hinton Township', 'Holland Township', 'Holland City', 'Holland Charter Township', 'Holly Village', 'Holly Township', 'Holmes Township', 'Holton Township', 'Home Township', 'Home Township', 'Homer Village', 'Homer Township', 'Homer Township', 'Homestead Township', 'Honor Village', 'Hope Township', 'Hope Township', 'Hopkins Village', 'Hopkins Township', 'Horton Township', 'Houghton City', 'Houghton Township', 'Howard Township', 'Howard City Village', 'Howell City', 'Howell Township', 'Hubbardston Village', 'Hudson Township', 'Hudson City', 'Hudson Township', 'Hudson Township', 'Hudsonville City', 'Hulbert Township', 'Humboldt Township', 'Hume Township', 'Huntington Woods City', 'Huron Township', 'Huron Charter Township', 'Ida Township', 'Imlay Township', 'Imlay City City', 'Independence Charter Township', 'Indianfields Township', 'Ingallston Township', 'Ingersoll Township', 'Ingham Township', 'Inkster City', 'Inland Township', 'Interior Township', 'Inverness Township', 'Inwood Township', 'Ionia City', 'Ionia Township', 'Iosco Township', 'Ira Township', 'Iron Mountain City', 'Iron River City', 'Iron River Township', 'Ironwood City', 'Ironwood Charter Township', 'Irving Township', 'Isabella Township', 'Ishpeming City', 'Ishpeming Township', 'Ithaca City', 'Jackson City', 'James Township', 'Jamestown Charter Township', 'Jasper Township', 'Jefferson Township', 'Jefferson Township', 'Jerome Township', 'Johnstown Township', 'Jonesfield Township', 'Jonesville City', 'Jordan Township', 'Joyfield Township', 'Juniata Township', 'Kalamazoo City', 'Kalamazoo Charter Township', 'Kalamo Township', 'Kaleva Village', 'Kalkaska Village', 'Kalkaska Township', 'Kasson Township', 'Kawkawlin Township', 'Kearney Township', 'Keego Harbor City', 'Keeler Township', 'Keene Township', 'Kenockee Township', 'Kent City Village', 'Kentwood City', 'Kimball Township', 'Kinde Village', 'Kinderhook Township', 'Kingsford City', 'Kingsley Village', 'Kingston Village', 'Kingston Township', 'Kinross Charter Township', 'Klacking Township', 'Kochville Township', 'Koehler Township', 'Koylton Township', 'Krakow Township', 'Lafayette Township', 'LaGrange Township', 'Laingsburg City', 'Laird Township', 'Lake Township', 'Lake Charter Township', 'Lake Township', 'Lake Township', 'Lake Township', 'Lake Township', 'Lake Township', 'Lake Angelus City', 'Lake Ann Village', 'Lake City City', 'Lakefield Township', 'Lakefield Township', 'Lake Isabella Village', 'Lake Linden Village', 'Lake Odessa Village', 'Lake Orion Village', 'Laketon Township', 'Laketown Township', 'Lakeview Village', 'Lakewood Club Village', 'Lamotte Township', 'L\'Anse Township', 'Lansing‡ City', 'Lansing Charter Township', 'Lapeer City', 'Lapeer Township', 'Larkin Charter Township', 'La Salle Township', 'Lathrup Village City', 'Laurium Village', 'Lawrence Village', 'Lawrence Township', 'Lawton Village', 'Leavitt Township', 'Lebanon Township', 'Lee Township', 'Lee Township', 'Lee Township', 'Leelanau Township', 'Leighton Township', 'Leland Township', 'Lennon Village', 'Lenox Township', 'Leonard Village', 'Leoni Township', 'Leonidas Township', 'Leroy Township', 'Leroy Township', 'LeRoy Village', 'LeRoy Township', 'Leslie City', 'Leslie Township', 'Lexington Village', 'Lexington Township', 'Liberty Township', 'Liberty Township', 'Lilley Township', 'Lima Township', 'Limestone Township', 'Lincoln Village', 'Lincoln Township', 'Lincoln Charter Township', 'Lincoln Township', 'Lincoln Township', 'Lincoln Township', 'Lincoln Township', 'Lincoln Township', 'Lincoln Township', 'Lincoln Park City', 'Linden City', 'Litchfield City', 'Litchfield Township', 'Littlefield Township', 'Little Traverse Township', 'Livingston Township', 'Livonia City', 'Locke Township', 'Lockport Township', 'Lodi Township', 'Logan Township', 'Logan Township', 'London Township', 'Long Lake Charter Township', 'Long Rapids Township', 'Loud Township', 'Lovells Township', 'Lowell City', 'Lowell Charter Township', 'Ludington City', 'Luna Pier City', 'Luther Village', 'Lyndon Township', 'Lynn Township', 'Lyon Charter Township', 'Lyon Township', 'Lyons Village', 'Lyons Township', 'McBain City', 'McBride Village', 'Mackinac Island City', 'Mackinaw Township', 'Mackinaw City Village', 'McKinley Township', 'McKinley Township', 'McMillan Township', 'McMillan Township', 'Macomb Township', 'Macon Township', 'Madison Charter Township', 'Madison Heights City', 'Mancelona Village', 'Mancelona Township', 'Manchester City', 'Manchester Township', 'Manistee City', 'Manistee Township', 'Manistique City', 'Manistique Township', 'Manlius Township', 'Mansfield Township', 'Manton City', 'Maple Forest Township', 'Maple Grove Township', 'Maple Grove Township', 'Maple Grove Township', 'Maple Rapids Village', 'Maple Ridge Township', 'Maple Ridge Township', 'Maple River Township', 'Maple Valley Township', 'Maple Valley Township', 'Marathon Township', 'Marcellus Village', 'Marcellus Township', 'Marengo Township', 'Marenisco Township', 'Marilla Township', 'Marine City City', 'Marion Township', 'Marion Township', 'Marion Village', 'Marion Township', 'Marion Township', 'Marion Township', 'Markey Township', 'Marlette City', 'Marlette Township', 'Marquette Township', 'Marquette City', 'Marquette Charter Township', 'Marshall City', 'Marshall Township', 'Martin Village', 'Martin Township', 'Martiny Township', 'Marysville City', 'Mason Township', 'Mason Township', 'Mason City', 'Masonville Township', 'Mastodon Township', 'Matchwood Township', 'Mathias Township', 'Mattawan Village', 'Matteson Township', 'Maybee Village', 'Mayfield Township', 'Mayfield Township', 'Mayville Village', 'Meade Township', 'Meade Township', 'Mecosta Village', 'Mecosta Township', 'Medina Township', 'Mellen Township', 'Melrose Township', 'Melvin Village', 'Melvindale City', 'Memphis City', 'Mendon Village', 'Mendon Township', 'Menominee City', 'Menominee Township', 'Mentor Township', 'Mentor Township', 'Meridian Charter Township', 'Merrill Township', 'Merrill Village', 'Merritt Township', 'Mesick Village', 'Metamora Village', 'Metamora Township', 'Metz Township', 'Meyer Township', 'Michiana Village', 'Michigamme Township', 'Middle Branch Township', 'Middlebury Township', 'Middleville Village', 'Midland City', 'Midland Charter Township', 'Mikado Township', 'Milan Township', 'Milan City', 'Milford Village', 'Milford Charter Township', 'Millbrook Township', 'Millen Township', 'Millersburg Village', 'Millington Village', 'Millington Township', 'Mills Township', 'Mills Township', 'Milton Township', 'Milton Township', 'Minden Township', 'Minden City Village', 'Mitchell Township', 'Moffatt Township', 'Moltke Township', 'Monitor Charter Township', 'Monroe City', 'Monroe Charter Township', 'Monroe Township', 'Montague City', 'Montague Township', 'Montcalm Township', 'Monterey Township', 'Montgomery Village', 'Montmorency Township', 'Montrose City', 'Montrose Charter Township', 'Moore Township', 'Moorland Township', 'Moran Township', 'Morenci City', 'Morley Village', 'Morrice Village', 'Morton Township', 'Moscow Township', 'Mottville Township', 'Mount Clemens City', 'Mount Forest Township', 'Mount Haley Township', 'Mount Morris City', 'Mount Morris Charter Township', 'Mount Pleasant City', 'Mueller Township', 'Muir Village', 'Mullett Township', 'Mulliken Village', 'Mundy Charter Township', 'Munising City', 'Munising Township', 'Munro Township', 'Muskegon City', 'Muskegon Charter Township', 'Muskegon Heights City', 'Mussey Township', 'Nadeau Township', 'Nahma Township', 'Napoleon Township', 'Nashville Village', 'Negaunee City', 'Negaunee Township', 'Nelson Township', 'Nester Township', 'Newark Township', 'Newaygo City', 'New Baltimore City', 'Newberg Township', 'Newberry Village', 'New Buffalo City', 'New Buffalo Township', 'New Era Village', 'Newfield Township', 'New Haven Township', 'New Haven Village', 'New Haven Township', 'Newkirk Township', 'New Lothrop Village', 'Newton Township', 'Newton Township', 'Niles City', 'Niles Charter Township', 'Noble Township', 'Norman Township', 'North Adams Village', 'North Allis Township', 'North Branch Village', 'North Branch Township', 'Northfield Township', 'North Muskegon City', 'North Plains Township', 'Northport Village', 'North Shade Township', 'North Star Township', 'Northville City', 'Northville Charter Township', 'Norton Shores City', 'Norvell Township', 'Norway City', 'Norway Township', 'Norwich Township', 'Norwich Township', 'Norwood Township', 'Nottawa Township', 'Nottawa Township', 'Novesta Township', 'Novi City', 'Novi Township', 'Nunda Township', 'Oakfield Township', 'Oakland Charter Township', 'Oakley Village', 'Oak Park City', 'Oceola Township', 'Ocqueoc Township', 'Odessa Township', 'Ogden Township', 'Ogemaw Township', 'Olive Township', 'Olive Township', 'Oliver Township', 'Oliver Township', 'Olivet City', 'Omer City', 'Onaway City', 'Oneida Charter Township', 'Onekama Village', 'Onekama Township', 'Onondaga Township', 'Onota Township', 'Onsted Village', 'Ontonagon Village', 'Ontonagon Township', 'Ontwa Township', 'Orange Township', 'Orange Township', 'Orangeville Township', 'Orchard Lake Village City', 'Oregon Township', 'Orient Township', 'Orion Charter Township', 'Orleans Township', 'Oronoko Charter Township', 'Ortonville Village', 'Osceola Township', 'Osceola Township', 'Oscoda Charter Township', 'Oshtemo Charter Township', 'Ossineke Township', 'Otisco Township', 'Otisville Village', 'Otsego City', 'Otsego Township', 'Otsego Lake Township', 'Otter Lake Village', 'Otto Township', 'Overisel Township', 'Ovid Township', 'Ovid City', 'Ovid Township', 'Owendale Village', 'Owosso City', 'Owosso Charter Township', 'Oxford Village', 'Oxford Charter Township', 'Palmyra Township', 'Paradise Township', 'Parchment City', 'Paris Township', 'Park Township', 'Park Township', 'Parma Village', 'Parma Township', 'Pavilion Township', 'Paw Paw Village', 'Paw Paw Township', 'Peacock Township', 'Peaine Township', 'Peck Village', 'Pellston Village', 'Peninsula Township', 'Penn Township', 'Pennfield Charter Township', 'Pentland Township', 'Pentwater Village', 'Pentwater Township', 'Pere Marquette Charter Township', 'Perrinton Village', 'Perry City', 'Perry Township', 'Petersburg City', 'Petoskey City', 'Pewamo Village', 'Pickford Township', 'Pierson Village', 'Pierson Township', 'Pigeon Village', 'Pinckney Village', 'Pinconning City', 'Pinconning Township', 'Pine Township', 'Pine Grove Township', 'Pine River Township', 'Pinora Township', 'Pioneer Township', 'Pipestone Township', 'Pittsfield Charter Township', 'Pittsford Township', 'Plainfield Township', 'Plainfield Charter Township', 'Plainwell City', 'Platte Township', 'Pleasanton Township', 'Pleasant Plains Township', 'Pleasant Ridge City', 'Pleasantview Township', 'Plymouth City', 'Plymouth Charter Township', 'Pointe Aux Barques Township', 'Pokagon Township', 'Polkton Charter Township', 'Pontiac City', 'Portage Charter Township', 'Portage City', 'Portage Township', 'Port Austin Village', 'Port Austin Township', 'Porter Township', 'Porter Township', 'Porter Township', 'Port Hope Village', 'Port Huron City', 'Port Huron Charter Township', 'Portland City', 'Portland Township', 'Port Sanilac Village', 'Port Sheldon Township', 'Portsmouth Charter Township', 'Posen Village', 'Posen Township', 'Potterville City', 'Powell Township', 'Powers Village', 'Prairie Ronde Township', 'Prairieville Township', 'Prescott Village', 'Presque Isle Township', 'Pulaski Township', 'Pulawski Township', 'Putnam Township', 'Quincy Village', 'Quincy Township', 'Quincy Township', 'Raber Township', 'Raisin Charter Township', 'Raisinville Township', 'Ransom Township', 'Rapid River Township', 'Ravenna Village', 'Ravenna Township', 'Ray Township', 'Reading City', 'Reading Township', 'Readmond Township', 'Redding Township', 'Redford Charter Township', 'Reed City City', 'Reeder Township', 'Reese Village', 'Reno Township', 'Republic Township', 'Resort Township', 'Reynolds Township', 'Rich Township', 'Richfield Township', 'Richfield Township', 'Richland Village', 'Richland Township', 'Richland Township', 'Richland Township', 'Richland Township', 'Richland Township', 'Richmond City', 'Richmond Township', 'Richmond Township', 'Richmond Township', 'Ridgeway Township', 'Riga Township', 'Riley Township', 'Riley Township', 'River Rouge City', 'Riverside Township', 'Riverton Township', 'Riverview City', 'Rives Township', 'Robinson Township', 'Rochester City', 'Rochester Hills City', 'Rockford City', 'Rockland Township', 'Rock River Township', 'Rockwood City', 'Rogers Township', 'Rogers City City', 'Rolland Township', 'Rollin Township', 'Rome Township', 'Romeo Village', 'Romulus City', 'Ronald Township', 'Roosevelt Park City', 'Roscommon Village', 'Roscommon Township', 'Rose Township', 'Rose Township', 'Rosebush Village', 'Rose City City', 'Rose Lake Township', 'Roseville City', 'Ross Township', 'Rothbury Village', 'Roxand Township', 'Royal Oak City', 'Royal Oak Charter Township', 'Royalton Township', 'Rubicon Township', 'Rudyard Township', 'Rush Township', 'Rust Township', 'Rutland Charter Township', 'Sage Township', 'Saginaw City', 'Saginaw Charter Township', 'Sagola Township', 'St. Charles Village', 'St. Charles Township', 'St. Clair City', 'St. Clair Township', 'St. Clair Shores City', 'St. Ignace City', 'St. Ignace Township', 'St. James Township', 'St. Johns City', 'St. Joseph City', 'St. Joseph Charter Township', 'St. Louis City', 'Salem Township', 'Salem Township', 'Saline City', 'Saline Township', 'Sanborn Township', 'Sand Beach Township', 'Sand Lake Village', 'Sands Township', 'Sandstone Charter Township', 'Sandusky City', 'Sanford Village', 'Sanilac Township', 'Saranac Village', 'Sauble Township', 'Saugatuck City', 'Saugatuck Township', 'Sault Ste. Marie City', 'Schoolcraft Township', 'Schoolcraft Village', 'Schoolcraft Township', 'Scio Township', 'Sciota Township', 'Scipio Township', 'Scottville City', 'Sebewa Township', 'Sebewaing Village', 'Sebewaing Township', 'Secord Township', 'Selma Township', 'Seneca Township', 'Seney Township', 'Seville Township', 'Sharon Township', 'Shelby Charter Township', 'Shelby Village', 'Shelby Township', 'Shepherd Village', 'Sheridan Township', 'Sheridan Township', 'Sheridan Township', 'Sheridan Township', 'Sheridan Township', 'Sheridan Village', 'Sheridan Charter Township', 'Sherman Township', 'Sherman Township', 'Sherman Township', 'Sherman Township', 'Sherman Township', 'Sherman Township', 'Sherman Township', 'Sherman Township', 'Sherman Township', 'Sherwood Village', 'Sherwood Township', 'Shiawassee Township', 'Shoreham Village', 'Sidney Township', 'Sigel Township', 'Silver Creek Township', 'Sims Township', 'Skandia Township', 'Slagle Township', 'Sodus Township', 'Solon Township', 'Solon Township', 'Somerset Township', 'Soo Township', 'South Arm Township', 'South Branch Township', 'South Branch Township', 'Southfield City', 'Southfield Township', 'Southgate City', 'South Haven City', 'South Haven Charter Township', 'South Lyon City', 'South Range Village', 'South Rockwood Village', 'Spalding Township', 'Sparta Village', 'Sparta Township', 'Spaulding Township', 'Speaker Township', 'Spencer Township', 'Spring Arbor Township', 'Springdale Township', 'Springfield City', 'Springfield Township', 'Springfield Charter Township', 'Spring Lake Village', 'Spring Lake Township', 'Springport Village', 'Springport Township', 'Springvale Township', 'Springville Township', 'Spurr Township', 'Stambaugh Township', 'Standish City', 'Standish Township', 'Stannard Township', 'Stanton Township', 'Stanton City', 'Stanwood Village', 'Star Township', 'Stephenson City', 'Stephenson Township', 'Sterling Village', 'Sterling Heights City', 'Stevensville Village', 'Stockbridge Village', 'Stockbridge Township', 'Stronach Township', 'Sturgis City', 'Sturgis Township', 'Sugar Island Township', 'Sullivan Township', 'Summerfield Township', 'Summerfield Township', 'Summit Township', 'Summit Township', 'Sumner Township', 'Sumpter Township', 'Sunfield Village', 'Sunfield Township', 'Superior Township', 'Superior Charter Township', 'Surrey Township', 'Suttons Bay Village', 'Suttons Bay Township', 'Swan Creek Township', 'Swartz Creek City', 'Sweetwater Township', 'Sylvan Township', 'Sylvan Township', 'Sylvan Lake City', 'Tallmadge Charter Township', 'Tawas Township', 'Tawas City City', 'Taylor City', 'Taymouth Township', 'Tecumseh City', 'Tecumseh Township', 'Tekonsha Village', 'Tekonsha Township', 'Texas Charter Township', 'Thetford Township', 'Thomas Township', 'Thompson Township', 'Thompsonville Village', 'Thornapple Township', 'Three Oaks Village', 'Three Oaks Township', 'Three Rivers City', 'Tilden Township', 'Tittabawassee Township', 'Tobacco Township', 'Tompkins Township', 'Torch Lake Township', 'Torch Lake Township', 'Traverse City City', 'Trenton City', 'Trout Lake Township', 'Trowbridge Township', 'Troy Township', 'Troy City', 'Turin Township', 'Turner Village', 'Turner Township', 'Tuscarora Township', 'Tuscola Township', 'Tustin Village', 'Twining Village', 'Tyrone Township', 'Tyrone Township', 'Ubly Village', 'Unadilla Township', 'Union Township', 'Union Township', 'Union Charter Township', 'Union City Village', 'Unionville Village', 'Utica City', 'Valley Township', 'Van Buren Charter Township', 'Vandalia Village', 'Vanderbilt Village', 'Vassar City', 'Vassar Township', 'Venice Township', 'Vergennes Township', 'Vermontville Village', 'Vermontville Township', 'Vernon Township', 'Vernon Village', 'Vernon Township', 'Verona Township', 'Vevay Township', 'Vicksburg Village', 'Victor Township', 'Victory Township', 'Vienna Charter Township', 'Vienna Township', 'Village of Clarkston City', 'Village of Grosse Pointe Shores City', 'Volinia Township', 'Wakefield City', 'Wakefield Township', 'Wakeshma Township', 'Waldron Village', 'Wales Township', 'Walker Township', 'Walker City', 'Walkerville Village', 'Walled Lake City', 'Walton Township', 'Warner Township', 'Warren City', 'Warren Township', 'Washington Township', 'Washington Charter Township', 'Washington Township', 'Waterford Charter Township', 'Waterloo Township', 'Watersmeet Township', 'Watertown Charter Township', 'Watertown Township', 'Watertown Township', 'Watervliet City', 'Watervliet Township', 'Watson Township', 'Waucedah Township', 'Waverly Township', 'Waverly Township', 'Wawatam Township', 'Wayland City', 'Wayland Township', 'Wayne Township', 'Wayne City', 'Weare Township', 'Webber Township', 'Webberville Village', 'Webster Township', 'Weesaw Township', 'Weldon Township', 'Wellington Township', 'Wells Township', 'Wells Township', 'Wells Township', 'West Bloomfield Charter Township', 'West Branch Township', 'West Branch Township', 'West Branch Township', 'West Branch City', 'West Branch Township', 'Westland City', 'Westphalia Village', 'Westphalia Township', 'West Traverse Township', 'Wexford Township', 'Wheatfield Township', 'Wheatland Township', 'Wheatland Township', 'Wheatland Township', 'Wheeler Township', 'White Cloud City', 'Whitefish Township', 'Whiteford Township', 'Whitehall City', 'Whitehall Township', 'White Lake Charter Township', 'White Oak Township', 'White Pigeon Village', 'White Pigeon Township', 'White River Township', 'Whitewater Township', 'Whitney Township', 'Whittemore City', 'Wilber Township', 'Wilcox Township', 'Williams Charter Township', 'Williamston City', 'Williamstown Township', 'Wilmot Township', 'Wilson Township', 'Windsor Charter Township', 'Winfield Township', 'Winsor Township', 'Winterfield Township', 'Wise Township', 'Wisner Township', 'Wixom City', 'Wolverine Village', 'Wolverine Lake Village', 'Woodbridge Township', 'Woodhaven City', 'Woodhull Township', 'Woodland Village', 'Woodland Township', 'Woodstock Township', 'Worth Township', 'Wright Township', 'Wright Township', 'Wyandotte City', 'Wyoming City', 'Yale City', 'Yankee Springs Township', 'Yates Township', 'York Charter Township', 'Ypsilanti City', 'Ypsilanti Charter Township', 'Zeeland City', 'Zeeland Charter Township', 'Zilwaukee City', 'Zilwaukee Township']
MUNICIP = sorted(list(set(MUNICIP)))


from flask import request, jsonify
import requests

@webapp_main.route('/register', methods=['GET', 'POST'])
def register1():
    if request.method == 'POST':
        # Gather data from the form
        first_name = request.form.get('first_name')
        last_name = request.form.get('last_name')
        email = request.form.get('email')
        # ... gather other fields ...

        # Prepare data for the API request
        api_data = {
            "first": first_name,
            "last": last_name,
            "email": email,
        }

        # Make a request to the RESTful API endpoint
        response = requests.post('http://localhost:5000/api/person', json=api_data)

        if response.status_code == 201:
            # Handle success
            return 'Registration successful'
        else:
            # Handle errors
            return 'Registration failed', response.status_code

    # For GET request, render the registration form
    return render_template('register.html', municipalities=MUNICIP)


@webapp_main.route('/register22', methods=['GET', 'POST'])
def register_model():
    if request.method == 'POST':
        first_name = request.form.get('first_name')
        last_name = request.form.get('last_name')
        username = request.form.get('username')
        password = request.form.get('password')
        password2 = request.form.get('password2')
        if password != password2:
            flash('Your passwords do not match')
            return render_template('register.html', municipalities=MUNICIP)
        if not len(password) > 5:
            flash('Password must be 5 characters')
            return render_template('register.html', municipalities=MUNICIP)
        email = request.form.get('email')
        phone = request.form.get('phone')
        street = request.form.get('street')
        city = request.form.get('city')
        state = request.form.get('state')
        if state.lower() == 'mi' or state.lower == 'michigan':
            state = 'Michigan'
        if state != 'Michigan':
            flash('Sorry, membership is not available in your area.')
            return render_template('register.html', municipalities=MUNICIP)
        zip_code = request.form.get('zip_code')

        # Check if user already exists
        existing_user = PersonCredentials.get_or_none(PersonCredentials.user_id == username)
        if existing_user:
            flash('Username already exists')
            return redirect(url_for('webapp_main.register'))

        # Create new user
        new_person = Person.create(first=first_name, last=last_name, email=email)
        new_person.save()

        # Hash password and save credentials
        hashed_password = generate_password_hash(password)
        new_credentials = PersonCredentials.create(
            uid=None,
            user_id=username,
            password_hash=hashed_password,
            person=new_person,
            email=email
        )
        new_credentials.save()

        # New code to handle PersonEmergencyContact and PersonContact
        emergency_email = request.form.get('emergency_email')
        emergency_phone = request.form.get('emergency_phone')
        emergency_first_name = request.form.get('emergency_first_name')
        emergency_last_name = request.form.get('emergency_last_name')

        new_emergency_contact = PersonEmergencyContact.create(
            email=emergency_email,
            phone=emergency_phone,
            first=emergency_first_name,
            last=emergency_last_name,
            person=new_person
        )
        new_emergency_contact.save()

        new_person_contact = PersonContact.create(
            phone=phone,
            street=street,
            city=city,
            state=state,
            zip_code=zip_code,
            person=new_person
        )
        new_person_contact.save()

        flash('Registration successful')
        return redirect(url_for('webapp_main.index'))

    return render_template('register.html', municipalities=MUNICIP)

@webapp_main.route('/reset-password-request', methods=['GET', 'POST'])
def reset_password_request():
    if request.method == 'POST':
        email = request.form.get('email')
        user = PersonCredentials.get_or_none(PersonCredentials.email == email)
        if user:
            # Generate a token
            serializer = URLSafeTimedSerializer(app.config['SECRET_KEY'])
            token = serializer.dumps(user.user_id, salt=app.config['SECURITY_PASSWORD_SALT'])

            # Save token to database
            PasswordResetToken.create_token_for_user(user=user, token=token)

            # Send email with SendGrid (not shown here)

        # Redirect or show a message
        flash('If the email is registered, you will receive a password reset link.')

    return render_template('reset_password_request.html')

def get_user_id_from_token(token, secret_key, salt, max_age=3600):
    serializer = URLSafeTimedSerializer(secret_key)
    try:
        user_id = serializer.loads(token, salt=salt, max_age=max_age)
        return user_id
    except SignatureExpired:
        # Handle the case when the token is valid but expired
        return None
    except BadSignature:
        # Handle the case when the token is invalid
        return None

@webapp_main.route('/reset-password/<token>', methods=['GET', 'POST'])
def reset_password(token):
    user_id = get_user_id_from_token(token, app.config['SECRET_KEY'], app.config['SECURITY_PASSWORD_SALT'])

    if user_id is None:
        # Handle invalid or expired token
        flash('The password reset link is invalid or has expired.')
        return redirect(url_for('webapp_main.reset_password_request'))

    if request.method == 'POST':
        new_password = request.form.get('password')
        # Validate and update the password
        PersonCredentials.update_password(user_id=user_id, new_password=new_password)

        # Additional logic (e.g., invalidating the token)

        flash('Your password has been reset successfully.')
        return redirect(url_for('webapp_main.login'))

    return render_template('reset_password.html')

@webapp_main.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')

        user = PersonCredentials.get_or_none(PersonCredentials.user_id == username)
        if user and check_password_hash(user.password_hash, password):
            resp = make_response(redirect(url_for('webapp_main.index')))
            resp.set_cookie('user_id', username)
            return resp

        flash('Invalid username or password')
        return redirect(url_for('webapp_main.login'))

    return render_template('login.html')

@webapp_main.route('/logout')
def logout():
    resp = make_response(redirect(url_for('webapp_main.index')))
    resp.delete_cookie('user_id')  # Delete the user_id cookie
    flash('You have been logged out.')
    return resp

@webapp_main.route('/')
def index():
    user_id = request.cookies.get('user_id')
    if not user_id:
        return redirect(url_for('webapp_main.login'))

    user = PersonCredentials.get_or_none(PersonCredentials.user_id == user_id)
    if not user:
        return redirect(url_for('webapp_main.login'))

    # Check if the user is an admin
    is_admin = PersonRbac.get_or_none((PersonRbac.person == user.person) & (PersonRbac.role == 'admin') & (PersonRbac.permission == True))
    
    return render_template('index.html', user=user.person, is_admin=bool(is_admin))